# Milestone v2.0: Autonomous Context Management

**Status:** SHIPPED 2026-02-18
**Phases:** 6-7
**Total Plans:** 6

## Overview

v2 delivers the autonomy spectrum for context management — the second core value of Trace. Phase 6 implements a policy engine with 4 built-in policies (auto-compress, auto-pin, auto-branch, auto-rebase) that trigger context operations based on configurable rules and thresholds. Phase 7 exposes all Tract operations as an agent toolkit and ships a lightweight orchestrator that uses it, completing the manual → collaborative → autonomous spectrum.

## Phases

### Phase 6: Policy Engine

**Goal**: Users can define declarative policies that automatically trigger context operations (compress, pin, branch, rebase) based on configurable rules and thresholds, with human override at any point
**Depends on**: Phase 5 (uses all existing context operations as building blocks)
**Plans**: 3 plans

Plans:

- [x] 06-01-PLAN.md -- Storage foundation: PolicyProposalRow + PolicyLogRow schema (v5 migration), PolicyRepository ABC, SqlitePolicyRepository, domain models, exceptions
- [x] 06-02-PLAN.md -- Policy ABC, PolicyEvaluator sidecar, Tract facade integration (configure_policies, register_policy, pause/resume, compile/commit hooks, config persistence)
- [x] 06-03-PLAN.md -- Built-in policies (CompressPolicy, PinPolicy, BranchPolicy, RebasePolicy), unit tests, end-to-end integration tests

**Details:**
- PolicyEvaluator as sidecar class connected via `_policy_evaluator` attribute
- Compile-triggered policies run BEFORE compilation; commit-triggered run AFTER commit
- Cooldown per-policy-name with configurable seconds
- Policy config persisted to `_trace_meta` as JSON under key "policy_config"
- Auto-load on `Tract.open()` for restart persistence
- CompressPolicy: threshold-based (default 90% budget), preserves PINNED
- PinPolicy: content-type matching (InstructionContent/SessionContent), retroactive scan
- BranchPolicy: tangent detection via content type switching patterns
- RebasePolicy: stale branch detection (min_commits AND stale_days conditions)

**Completed:** 2026-02-17
**Tests:** 113 new (798 total)
**Duration:** 20m

### Phase 7: Agent Toolkit & Orchestrator

**Goal**: Expose Tract operations as an agent toolkit (tool schemas with customizable prompts and profiles) and ship a lightweight built-in orchestrator that uses the toolkit. The orchestrator is policy-integrated: policies trigger it, it reasons via LLM, policies constrain it. This completes the autonomy spectrum from Core Value #2.
**Depends on**: Phase 6 (policy engine provides the rule infrastructure)
**Plans**: 3 plans

Plans:

- [x] 07-01-PLAN.md -- Toolkit foundation: ToolDefinition, ToolProfile, ToolConfig models, 15 hand-crafted tool definitions, 3 built-in profiles (self/supervisor/full), ToolExecutor, Tract.as_tools() facade
- [x] 07-02-PLAN.md -- Orchestrator models: OrchestratorConfig, AutonomyLevel, OrchestratorState, TriggerConfig, OrchestratorProposal, ProposalResponse, built-in callbacks (auto_approve, log_and_approve, cli_prompt), assessment prompts
- [x] 07-03-PLAN.md -- Orchestrator loop: Orchestrator class (assess->LLM->tools->repeat), stop/pause lifecycle, policy integration (_orchestrating guard), Tract.orchestrate() facade, integration tests

**Details:**
- 15 tool definitions covering all Tract operations
- 3 profiles: self-management (5 tools), supervisor (10 tools), full (15 tools)
- ToolExecutor dispatches tool calls with parameter validation
- Orchestrator loop: assess -> LLM -> extract tool calls -> execute -> repeat
- Autonomy levels: MANUAL, COLLABORATIVE, AUTONOMOUS with ceiling enforcement
- Trigger-based auto-invocation: on_commit_count, on_token_threshold, on_compile
- `_orchestrating` flag prevents policy-orchestrator recursion loops
- Stop (immediate) and pause (graceful) without data loss

**Completed:** 2026-02-18
**Tests:** 90 new (888 total)
**Duration:** 23m

---

## Milestone Summary

**Key Decisions:**

- Policy ABC uses abstract evaluate(), name, priority, trigger; defaults: priority=100, trigger="compile"
- PolicyEvaluator is sidecar class (not embedded in Tract); connected via _policy_evaluator attribute
- Compile-triggered policies run BEFORE compilation; commit-triggered run AFTER commit
- Handler lambdas use explicit parameter whitelisting (not **kwargs) to prevent hallucinated arguments
- ToolCall canonical location is orchestrator.models; toolkit re-exports
- Annotation counts via batch_get_latest for efficient assessment
- Trigger errors wrapped in try/except to never break commit/compile

**Issues Resolved:**

- Dead code: `_effective_autonomy(policy_autonomy)` parameter wired through `trigger_autonomy` on `run()`
- Dead defensive code: `try/except ImportError` replaced with direct import
- `ProposalDecision` and `ToolCall` added to top-level `tract/__init__.py` exports
- Post-phase polish changes committed as part of milestone completion

**Issues Deferred:**

- Virtual context with tiered storage (VCTX-01, VCTX-02)
- Semantic diff (SMDIFF-01)
- Trace blame and cross-agent audit queries (AUDIT-01, AUDIT-02)
- Framework adapters (ADAPT-01)
- Web/desktop DAG explorer (GUI-01)

**Technical Debt Incurred:**

- None remaining (3 tech debt items from audit were fixed before milestone completion)

---

_For current project status, see .planning/ROADMAP.md (created for next milestone)_
