---
phase: 05-multi-agent-release
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tract/storage/schema.py
  - src/tract/storage/repositories.py
  - src/tract/storage/sqlite.py
  - src/tract/storage/engine.py
  - src/tract/models/session.py
  - src/tract/models/content.py
  - src/tract/prompts/summarize.py
  - src/tract/exceptions.py
  - tests/test_spawn_storage.py
autonomous: true

must_haves:
  truths:
    - "SpawnPointerRow table exists in schema and is created by init_db()"
    - "Schema migration from v3 to v4 runs automatically for existing databases"
    - "SpawnPointerRepository ABC defines save, get, get_children, get_parent methods"
    - "SqliteSpawnPointerRepository implements all ABC methods with working SQLite queries"
    - "SessionContent model is a new content type addable to ContentPayload union"
    - "Collapse prompt is importable from tract.prompts.summarize alongside existing compression prompt"
    - "SpawnError and SessionError exceptions exist in tract.exceptions"
  artifacts:
    - path: "src/tract/storage/schema.py"
      provides: "SpawnPointerRow ORM table"
      contains: "SpawnPointerRow"
    - path: "src/tract/storage/repositories.py"
      provides: "SpawnPointerRepository ABC"
      contains: "class SpawnPointerRepository"
    - path: "src/tract/storage/sqlite.py"
      provides: "SqliteSpawnPointerRepository implementation"
      contains: "class SqliteSpawnPointerRepository"
    - path: "src/tract/storage/engine.py"
      provides: "v3->v4 migration"
      contains: "spawn_pointers"
    - path: "src/tract/models/session.py"
      provides: "SessionContent Pydantic model"
      contains: "class SessionContent"
    - path: "src/tract/models/content.py"
      provides: "SessionContent in ContentPayload union"
      contains: "SessionContent"
    - path: "src/tract/prompts/summarize.py"
      provides: "DEFAULT_COLLAPSE_SYSTEM, build_collapse_prompt"
      contains: "DEFAULT_COLLAPSE_SYSTEM"
    - path: "src/tract/exceptions.py"
      provides: "SpawnError, SessionError"
      contains: "class SpawnError"
  key_links:
    - from: "src/tract/storage/schema.py"
      to: "src/tract/storage/engine.py"
      via: "init_db() creates spawn_pointers table via v3->v4 migration"
      pattern: "spawn_pointers.*create"
    - from: "src/tract/storage/repositories.py"
      to: "src/tract/storage/sqlite.py"
      via: "SqliteSpawnPointerRepository implements SpawnPointerRepository ABC"
      pattern: "SpawnPointerRepository"
    - from: "src/tract/models/session.py"
      to: "src/tract/models/content.py"
      via: "SessionContent added to ContentPayload discriminated union"
      pattern: "SessionContent"
---

<objective>
Establish the storage foundation for multi-agent: spawn pointer table, repository pattern, SessionContent model, collapse prompt, and new exceptions.

Purpose: Multi-agent coordination requires cross-tract linkage via spawn pointers and session boundary commits. This plan adds the schema, storage layer, content model, and prompt that plans 05-02 and 05-03 build on. Same layered approach as 04-01 (storage first, operations second).

Output: SpawnPointerRow ORM table with v3->v4 migration, SpawnPointerRepository ABC + SQLite impl, SessionContent content type in the discriminated union, collapse-specific prompt, new exceptions, and ~25 tests. All existing 563 tests continue to pass.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-agent-release/05-CONTEXT.md
@.planning/phases/05-multi-agent-release/05-RESEARCH.md
@src/tract/storage/schema.py
@src/tract/storage/repositories.py
@src/tract/storage/sqlite.py
@src/tract/storage/engine.py
@src/tract/models/content.py
@src/tract/prompts/summarize.py
@src/tract/exceptions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: SpawnPointerRow schema + migration + repository</name>
  <files>
    src/tract/storage/schema.py
    src/tract/storage/repositories.py
    src/tract/storage/sqlite.py
    src/tract/storage/engine.py
  </files>
  <action>
    **schema.py** -- Add SpawnPointerRow ORM class after CompressionResultRow:

    `SpawnPointerRow(Base)` -- tablename "spawn_pointers":
    - `id: Mapped[int]` -- Integer, primary_key=True, autoincrement=True
    - `parent_tract_id: Mapped[str]` -- String(64), nullable=False
    - `parent_commit_hash: Mapped[Optional[str]]` -- String(64), ForeignKey("commits.commit_hash", ondelete="SET NULL"), nullable=True
    - `child_tract_id: Mapped[str]` -- String(64), nullable=False
    - `purpose: Mapped[str]` -- Text, nullable=False
    - `inheritance_mode: Mapped[str]` -- String(20), nullable=False (values: "full_clone", "head_snapshot", "selective")
    - `display_name: Mapped[Optional[str]]` -- String(255), nullable=True
    - `created_at: Mapped[datetime]` -- DateTime, nullable=False

    Table args with indexes:
    - `Index("ix_spawn_parent_tract", "parent_tract_id")`
    - `Index("ix_spawn_child_tract", "child_tract_id")`

    **repositories.py** -- Add `SpawnPointerRepository(ABC)` after CompressionRepository:
    - `save(parent_tract_id, parent_commit_hash, child_tract_id, purpose, inheritance_mode, display_name, created_at) -> SpawnPointerRow`: Save a new spawn pointer
    - `get(id: int) -> SpawnPointerRow | None`: Get spawn pointer by ID
    - `get_by_child(child_tract_id: str) -> SpawnPointerRow | None`: Get the spawn pointer where this tract is the child (a tract has at most one parent)
    - `get_children(parent_tract_id: str) -> list[SpawnPointerRow]`: Get all spawn pointers where this tract is the parent (ordered by created_at)
    - `get_all(tract_id: str) -> list[SpawnPointerRow]`: Get all spawn pointers involving this tract (as parent OR child)
    - `has_ancestor(child_tract_id: str, potential_ancestor: str) -> bool`: Check if potential_ancestor is an ancestor of child_tract_id in the spawn tree (for cycle detection)

    Import SpawnPointerRow from schema in the TYPE_CHECKING block.

    **sqlite.py** -- Add `SqliteSpawnPointerRepository(SpawnPointerRepository)`:
    - Implement all ABC methods using SQLAlchemy session queries
    - `save()` creates a SpawnPointerRow, adds to session, flushes, and returns the row
    - `get_by_child()` queries `where(SpawnPointerRow.child_tract_id == child_tract_id)`, returns first or None
    - `get_children()` queries `where(SpawnPointerRow.parent_tract_id == parent_tract_id).order_by(SpawnPointerRow.created_at)`
    - `get_all()` uses an OR condition on parent_tract_id or child_tract_id
    - `has_ancestor()` walks the spawn tree iteratively: start with child_tract_id, get its parent pointer, check if parent matches potential_ancestor, if not continue with parent's parent. Return True if found, False if root reached with no match. This prevents circular spawn references.
    - Import SpawnPointerRow from schema

    **engine.py** -- Add v3->v4 migration in `init_db()`:
    - After the existing `if existing is not None and existing.value == "2"` block, add:
      ```python
      if existing is not None and existing.value == "3":
          # Migrate v3 -> v4: create spawn_pointers table
          Base.metadata.tables["spawn_pointers"].create(engine, checkfirst=True)
          existing.value = "4"
          session.commit()
      ```
    - Update the new database version from "3" to "4" in the `if existing is None` block
    - Ensure the v2->v3 migration falls through to v3->v4 (so v2 databases get both migrations)

    Do NOT import SpawnPointerRepository or SqliteSpawnPointerRepository from `__init__.py` files yet -- that happens in plan 05-02 when Session is wired up.
  </action>
  <verify>
    Run `python -m pytest tests/ -x -q` -- all 563 existing tests pass (no regressions from schema changes).
    Run `python -c "from tract.storage.schema import SpawnPointerRow; print('OK')"` -- imports work.
    Run `python -c "from tract.storage.sqlite import SqliteSpawnPointerRepository; print('OK')"` -- imports work.
  </verify>
  <done>
    SpawnPointerRow ORM table in schema.py with 2 indexes. SpawnPointerRepository ABC in repositories.py with 6 methods. SqliteSpawnPointerRepository in sqlite.py implementing all 6 methods including cycle-detecting has_ancestor(). init_db() migrates v3->v4. All 563 existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: SessionContent model, collapse prompt, exceptions, and storage tests</name>
  <files>
    src/tract/models/session.py
    src/tract/models/content.py
    src/tract/prompts/summarize.py
    src/tract/exceptions.py
    tests/test_spawn_storage.py
  </files>
  <action>
    **models/session.py** -- Create new file with:

    1. `SessionContent(BaseModel)` -- Pydantic model for session boundary commits:
       - `content_type: Literal["session"] = "session"`
       - `session_type: Literal["start", "end", "handoff", "checkpoint"]`
       - `summary: str` (what happened / what was accomplished)
       - `decisions: list[str] = []` (key decisions made)
       - `failed_approaches: list[str] = []` (things that didn't work)
       - `next_steps: list[str] = []` (what to do next)

    2. `SpawnInfo` -- frozen dataclass for spawn pointer metadata:
       - `spawn_id: int`
       - `parent_tract_id: str`
       - `parent_commit_hash: str | None`
       - `child_tract_id: str`
       - `purpose: str`
       - `inheritance_mode: str`
       - `display_name: str | None`
       - `created_at: datetime`

    3. `CollapseResult` -- frozen dataclass for collapse operation results:
       - `parent_commit_hash: str | None` (the summary commit created in the parent; None if auto_commit=False)
       - `child_tract_id: str`
       - `summary_text: str` (the generated or user-provided summary text; always populated so caller can review before committing)
       - `summary_tokens: int`
       - `source_tokens: int`
       - `purpose: str`

    **models/content.py** -- Add SessionContent to the ContentPayload union:
    - Import `SessionContent` from `tract.models.session` at the top (after other model imports)
    - Add `SessionContent` to the `Union[...]` in `ContentPayload`
    - Add `"session"` to `BUILTIN_CONTENT_TYPES` set
    - Add `"session"` entry to `BUILTIN_TYPE_HINTS` dict:
      ```python
      "session": ContentTypeHints(
          default_priority="pinned",
          default_role="system",
          compression_priority=95,  # Protect session boundaries from compression
      ),
      ```

    **prompts/summarize.py** -- Add collapse-specific prompt constants and builder:

    1. `DEFAULT_COLLAPSE_SYSTEM: str` -- System prompt for collapse summarization:
       ```
       "You are summarizing the work of a subagent that was delegated a specific task. "
       "Your job is to produce a concise report for the parent agent.\n\n"
       "Guidelines:\n"
       "- Focus on OUTCOMES: what was accomplished, decided, or produced.\n"
       "- Include key findings, decisions made, and artifacts created.\n"
       "- Note any failures, blockers, or unresolved issues.\n"
       "- Preserve specific technical details: code snippets, configurations, "
       "exact values, error messages.\n"
       "- Omit the subagent's internal reasoning process unless it contains "
       "important caveats or trade-off analysis.\n"
       "- If a target token count is specified, aim for approximately that length.\n"
       'Begin with: "Subagent completed: [task summary]"'
       ```

    2. `build_collapse_prompt(messages_text: str, purpose: str, *, target_tokens: int | None = None, instructions: str | None = None) -> str`:
       - Build prompt: f"The subagent was delegated the following task:\n  Purpose: {purpose}\n\nSummarize the subagent's work:\n\n{messages_text}"
       - Append target tokens and instructions if provided (same pattern as build_summarize_prompt)

    **exceptions.py** -- Add after GCError:
    ```python
    class SpawnError(TraceError):
        """Raised when spawn or collapse operations fail."""

    class SessionError(TraceError):
        """Raised when session operations fail."""
    ```

    **tests/test_spawn_storage.py** -- Create test file covering:

    1. Schema tests (~5 tests):
       - `test_spawn_pointers_table_created`: init_db creates spawn_pointers table
       - `test_migration_v3_to_v4`: start with schema_version=3, call init_db, verify table + version=4
       - `test_migration_v2_to_v4`: start with schema_version=2, call init_db, verify both compression tables AND spawn_pointers table exist, version=4
       - `test_new_db_starts_at_v4`: fresh database gets schema_version=4
       - `test_spawn_pointer_row_roundtrip`: create SpawnPointerRow, save, retrieve

    2. Repository tests (~8 tests):
       - `test_save_and_get`: save() then get() returns matching data
       - `test_get_by_child`: get_by_child() returns the spawn pointer for a child tract
       - `test_get_by_child_not_found`: get_by_child() returns None for non-child tract
       - `test_get_children`: get_children() returns all children, ordered by created_at
       - `test_get_children_empty`: get_children() returns empty list for tract with no children
       - `test_get_all`: get_all() returns pointers where tract is parent OR child
       - `test_has_ancestor_true`: tract A spawns B spawns C; has_ancestor(C, A) is True
       - `test_has_ancestor_false`: unrelated tracts; has_ancestor() returns False

    3. Model tests (~6 tests):
       - `test_session_content_valid`: SessionContent validates with all fields
       - `test_session_content_in_union`: validate_content({"content_type": "session", ...}) returns SessionContent
       - `test_spawn_info_frozen`: SpawnInfo is immutable
       - `test_collapse_result_frozen`: CollapseResult is immutable
       - `test_session_content_type_hints`: "session" in BUILTIN_TYPE_HINTS

    4. Prompt tests (~3 tests):
       - `test_collapse_system_prompt_not_empty`: DEFAULT_COLLAPSE_SYSTEM is non-empty string
       - `test_build_collapse_prompt_basic`: includes purpose and messages_text
       - `test_build_collapse_prompt_with_options`: includes target_tokens and instructions

    5. Exception tests (~2 tests):
       - `test_spawn_error_inherits_trace_error`: isinstance(SpawnError(), TraceError)
       - `test_session_error_inherits_trace_error`: isinstance(SessionError(), TraceError)

    Use the same test patterns as existing test files. For repository tests, create real commits in the DB since parent_commit_hash has a FK to commits.commit_hash. Use in-memory databases with session fixtures.
  </action>
  <verify>
    Run `python -m pytest tests/test_spawn_storage.py -v` -- all ~24 new tests pass.
    Run `python -m pytest tests/ -x -q` -- all existing tests plus new tests pass (total ~587).
    Run `python -c "from tract.models.session import SessionContent, SpawnInfo, CollapseResult; print('OK')"` -- models importable.
    Run `python -c "from tract.models.content import BUILTIN_CONTENT_TYPES; assert 'session' in BUILTIN_CONTENT_TYPES; print('OK')"` -- session type registered.
    Run `python -c "from tract.prompts.summarize import DEFAULT_COLLAPSE_SYSTEM, build_collapse_prompt; print('OK')"` -- collapse prompt importable.
    Run `python -c "from tract.exceptions import SpawnError, SessionError; print('OK')"` -- exceptions importable.
  </verify>
  <done>
    SessionContent Pydantic model in models/session.py added to ContentPayload union. SpawnInfo and CollapseResult frozen dataclasses. Collapse prompt in prompts/summarize.py. SpawnError and SessionError in exceptions.py. ~23 new tests covering schema, repository, models, prompts, and exceptions. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` -- all tests pass (563 existing + ~24 new)
2. `python -c "from tract.storage.schema import SpawnPointerRow"` -- schema importable
3. `python -c "from tract.storage.sqlite import SqliteSpawnPointerRepository"` -- repo importable
4. `python -c "from tract.models.session import SessionContent, SpawnInfo, CollapseResult"` -- models importable
5. `python -c "from tract.models.content import BUILTIN_CONTENT_TYPES; assert 'session' in BUILTIN_CONTENT_TYPES"` -- session content type registered
6. `python -c "from tract.prompts.summarize import DEFAULT_COLLAPSE_SYSTEM, build_collapse_prompt"` -- collapse prompt importable
7. `python -c "from tract.exceptions import SpawnError, SessionError"` -- exceptions importable
8. Schema migration: manually verify init_db() creates spawn_pointers table on fresh DB and migrates v3->v4
</verification>

<success_criteria>
1. SpawnPointerRow ORM table with indexes created by init_db()
2. Schema migration v3->v4 works for existing databases (Phase 4 databases at v3)
3. SpawnPointerRepository ABC has 6 methods; SqliteSpawnPointerRepository implements all including cycle detection
4. SessionContent is a valid content type in the ContentPayload discriminated union
5. Collapse prompt (DEFAULT_COLLAPSE_SYSTEM, build_collapse_prompt) exists alongside compression prompt
6. SpawnError and SessionError exceptions exist
7. ~24 new tests pass (including v2->v4 migration test); 563 existing tests have zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-agent-release/05-01-SUMMARY.md`
</output>
