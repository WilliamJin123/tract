---
phase: 02-linear-history-cli
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - pyproject.toml
  - src/tract/cli/__init__.py
  - src/tract/cli/commands/__init__.py
  - src/tract/cli/commands/log.py
  - src/tract/cli/commands/status.py
  - src/tract/cli/commands/diff.py
  - src/tract/cli/commands/reset.py
  - src/tract/cli/commands/checkout.py
  - src/tract/cli/formatting.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "User can run tract log and see commit history with hashes, timestamps, operations, and token counts"
    - "User can run tract status and see HEAD position, branch name, token usage, and recent commits"
    - "User can run tract diff and see colored textual differences between commits"
    - "User can run tract reset --soft/--hard to move HEAD"
    - "User can run tract checkout to switch to a commit or branch"
    - "CLI degrades gracefully when piped (no ANSI codes)"
    - "pip install tract (without [cli]) does NOT require Click or Rich"
  artifacts:
    - path: "src/tract/cli/__init__.py"
      provides: "Click group with lazy import guard"
      contains: "click.group"
    - path: "src/tract/cli/formatting.py"
      provides: "Rich formatting helpers for log, status, diff"
      contains: "format_log"
    - path: "src/tract/cli/commands/log.py"
      provides: "tract log command"
      contains: "def log"
    - path: "src/tract/cli/commands/status.py"
      provides: "tract status command"
      contains: "def status"
    - path: "src/tract/cli/commands/diff.py"
      provides: "tract diff command"
      contains: "def diff"
    - path: "src/tract/cli/commands/reset.py"
      provides: "tract reset command"
      contains: "def reset"
    - path: "src/tract/cli/commands/checkout.py"
      provides: "tract checkout command"
      contains: "def checkout"
    - path: "pyproject.toml"
      provides: "CLI optional extra and entry point"
      contains: "tract[cli]"
    - path: "tests/test_cli.py"
      provides: "CLI tests via CliRunner"
      min_lines: 100
  key_links:
    - from: "src/tract/cli/commands/log.py"
      to: "src/tract/tract.py"
      via: "CLI log calls Tract.log()"
      pattern: "tract_obj.log"
    - from: "src/tract/cli/commands/status.py"
      to: "src/tract/tract.py"
      via: "CLI status calls Tract.status()"
      pattern: "tract_obj.status"
    - from: "src/tract/cli/commands/diff.py"
      to: "src/tract/tract.py"
      via: "CLI diff calls Tract.diff()"
      pattern: "tract_obj.diff"
    - from: "pyproject.toml"
      to: "src/tract/cli/__init__.py"
      via: "Entry point for tract command"
      pattern: "tract.cli:cli"
---

<objective>
Build the CLI layer wrapping all five SDK operations (log, status, diff, reset, checkout) using Click for command parsing and Rich for terminal formatting.

Purpose: The CLI is the human-facing debugging interface for Trace. It makes the SDK operations accessible from the terminal. The CLI is a thin presentation wrapper -- all logic lives in the SDK.

Output: New `cli/` package with Click group, 5 commands, Rich formatting helpers. pyproject.toml updated with optional `[cli]` extra. CLI tests via CliRunner.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-linear-history-cli/02-CONTEXT.md
@.planning/phases/02-linear-history-cli/02-RESEARCH.md
@.planning/phases/02-linear-history-cli/02-01-SUMMARY.md
@.planning/phases/02-linear-history-cli/02-02-SUMMARY.md
@src/tract/tract.py
@src/tract/operations/history.py
@src/tract/operations/diff.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI package structure, Click group, formatting helpers, and pyproject.toml</name>
  <files>
    pyproject.toml
    src/tract/cli/__init__.py
    src/tract/cli/commands/__init__.py
    src/tract/cli/formatting.py
  </files>
  <action>
**1. Update `pyproject.toml`:**

Add CLI optional dependency group and entry point:

```toml
[project.optional-dependencies]
cli = [
    "click>=8.1,<9",
    "rich>=13.0,<15",
]
dev = [
    "pytest>=8.0",
    "hypothesis>=6.150",
    "pytest-cov>=7.0",
    "ruff>=0.15",
    "mypy>=1.14",
    "click>=8.1,<9",
    "rich>=13.0,<15",
]

[project.scripts]
tract = "tract.cli:cli"
```

Add click and rich to the dev dependencies too so tests can import them. The `[project.scripts]` entry point means `tract` command invokes the `cli` group from `tract.cli`.

**2. Create `src/tract/cli/__init__.py`:**

```python
"""Tract CLI: human-facing debugging interface.

Requires optional dependencies: pip install tract[cli]
"""
from __future__ import annotations

try:
    import click
except ImportError:
    raise ImportError(
        "CLI dependencies not installed. Install with: pip install tract[cli]"
    ) from None

from tract.tract import Tract


def _get_tract(ctx: click.Context) -> Tract:
    """Lazy-open a Tract instance from the Click context."""
    if "tract" not in ctx.obj:
        ctx.obj["tract"] = Tract.open(ctx.obj["db_path"])
    return ctx.obj["tract"]


@click.group()
@click.option("--db", default=".tract.db", envvar="TRACT_DB",
              help="Path to tract database.")
@click.pass_context
def cli(ctx: click.Context, db: str) -> None:
    """Tract: Git-like version control for LLM context windows."""
    ctx.ensure_object(dict)
    ctx.obj["db_path"] = db


# Register subcommands
from tract.cli.commands.log import log  # noqa: E402
from tract.cli.commands.status import status  # noqa: E402
from tract.cli.commands.diff import diff  # noqa: E402
from tract.cli.commands.reset import reset  # noqa: E402
from tract.cli.commands.checkout import checkout  # noqa: E402

cli.add_command(log)
cli.add_command(status)
cli.add_command(diff)
cli.add_command(reset)
cli.add_command(checkout)
```

IMPORTANT: The `tract.cli` module is NEVER imported from `tract/__init__.py` or any SDK module. It is only loaded when the `tract` console script entry point is invoked. This keeps Click/Rich as optional deps.

**3. Create `src/tract/cli/commands/__init__.py`:** Empty file.

**4. Create `src/tract/cli/formatting.py`:**

Rich formatting helpers used by all commands.

```python
"""Rich formatting helpers for Tract CLI output."""
from __future__ import annotations
from typing import TYPE_CHECKING

from rich.console import Console
from rich.table import Table
from rich.text import Text
from rich.syntax import Syntax

if TYPE_CHECKING:
    from tract.models.commit import CommitInfo
    from tract.operations.history import StatusInfo
    from tract.operations.diff import DiffResult
```

Functions to implement:

`get_console() -> Console`: Return a Rich Console instance. Rich auto-detects TTY.

`format_log_compact(entries: list[CommitInfo], console: Console) -> None`:
- Rich Table with box=None, pad_edge=False
- Columns: Hash (yellow, 8 chars, no_wrap), Time (dim, 19 chars), Op (6 chars), Tokens (right-aligned, 7 chars), Message (overflow=ellipsis)
- One row per entry: hash[:7], created_at formatted as "%Y-%m-%d %H:%M:%S", operation.value, token_count, message or ""

`format_log_verbose(entries: list[CommitInfo], console: Console) -> None`:
- Similar table but with additional columns: Content Type, Gen Config (key params)
- 2-3 lines per entry if needed

`format_status(info: StatusInfo, console: Console) -> None`:
- Print HEAD hash (or "No commits yet")
- Print branch name or "HEAD detached at {hash[:8]}"
- Print token budget progress bar or raw count
- Print last 3 commits as mini-preview (compact, 1 line each)

Token budget progress bar:
```python
def _format_token_budget(current: int, max_tokens: int | None, console: Console) -> None:
    if max_tokens is None:
        console.print(f"Tokens: {current:,} (no budget set)")
        return
    pct = min(current / max_tokens, 1.0)
    bar_width = 30
    filled = int(bar_width * pct)
    if pct < 1.0:
        bar = "=" * filled + ">" + "." * max(bar_width - filled - 1, 0)
    else:
        bar = "=" * bar_width
    style = "green" if pct < 0.7 else "yellow" if pct < 0.9 else "red"
    text = Text()
    text.append("Tokens: [")
    text.append(bar, style=style)
    text.append(f"] {pct:.0%} of {max_tokens:,}")
    console.print(text)
```

`format_diff(result: DiffResult, console: Console, stat_only: bool = False) -> None`:
- If stat_only: print summary line ("2 messages modified, 1 added, tokens: -55")
- Otherwise: for each MessageDiff:
  - If "added": show green "[+] Message {index}" with content
  - If "removed": show red "[-] Message {index}" with content
  - If "modified": show unified diff using Rich Syntax with "diff" lexer for coloring
  - If "unchanged": skip (don't show)
  - Show generation_config_changes if any
- If no differences: print "No differences"

`format_error(message: str, console: Console) -> None`:
- Print error in red: `[red]Error:[/red] {message}`
  </action>
  <verify>
1. `pip install -e ".[cli]"` succeeds (click and rich installed)
2. `python -c "from tract.cli import cli; print(cli.name)"` prints "cli"
3. `python -c "import tract"` succeeds WITHOUT requiring click/rich (verify no import of cli in __init__.py)
  </verify>
  <done>
pyproject.toml has [cli] optional extra with click and rich. Entry point `tract = "tract.cli:cli"` registered. CLI package has lazy import guard. Click group defined with --db option. Rich formatting helpers exist for log (compact + verbose), status (with progress bar), diff (with Syntax coloring), and error display. `import tract` does not require click/rich.
  </done>
</task>

<task type="auto">
  <name>Task 2: Five CLI commands + CLI tests</name>
  <files>
    src/tract/cli/commands/log.py
    src/tract/cli/commands/status.py
    src/tract/cli/commands/diff.py
    src/tract/cli/commands/reset.py
    src/tract/cli/commands/checkout.py
    tests/test_cli.py
  </files>
  <action>
**1. Create `src/tract/cli/commands/log.py`:**

```python
"""tract log -- show commit history."""
import click
from tract.cli import _get_tract
from tract.cli.formatting import get_console, format_log_compact, format_log_verbose

@click.command()
@click.option("-n", "--limit", default=20, type=int, help="Max commits to show.")
@click.option("-v", "--verbose", is_flag=True, help="Detailed output per commit.")
@click.option("--op", type=click.Choice(["append", "edit"], case_sensitive=False),
              help="Filter by operation type.")
@click.pass_context
def log(ctx, limit, verbose, op):
    """Show commit history."""
    from tract.models.commit import CommitOperation
    tract_obj = _get_tract(ctx)
    console = get_console()

    op_filter = CommitOperation(op) if op else None
    entries = tract_obj.log(limit=limit, op_filter=op_filter)

    if not entries:
        console.print("[dim]No commits yet[/dim]")
        return

    if verbose:
        format_log_verbose(entries, console)
    else:
        format_log_compact(entries, console)
```

**2. Create `src/tract/cli/commands/status.py`:**

```python
"""tract status -- show current tract state."""
import click
from tract.cli import _get_tract
from tract.cli.formatting import get_console, format_status

@click.command()
@click.pass_context
def status(ctx):
    """Show current tract status."""
    tract_obj = _get_tract(ctx)
    console = get_console()
    info = tract_obj.status()
    format_status(info, console)
```

**3. Create `src/tract/cli/commands/diff.py`:**

```python
"""tract diff -- compare two commits."""
import click
from tract.cli import _get_tract
from tract.cli.formatting import get_console, format_diff, format_error

@click.command()
@click.argument("commit_a", required=False)
@click.argument("commit_b", required=False)
@click.option("--stat", is_flag=True, help="Show summary only.")
@click.pass_context
def diff(ctx, commit_a, commit_b, stat):
    """Compare two commits.

    With no arguments, diffs HEAD against its parent.
    With one argument, diffs that commit against HEAD.
    EDIT commits auto-resolve to diff against their target.
    """
    tract_obj = _get_tract(ctx)
    console = get_console()

    try:
        result = tract_obj.diff(commit_a=commit_a, commit_b=commit_b)
        format_diff(result, console, stat_only=stat)
    except Exception as e:
        format_error(str(e), console)
        ctx.exit(1)
```

**4. Create `src/tract/cli/commands/reset.py`:**

```python
"""tract reset -- move HEAD to a previous commit."""
import click
from tract.cli import _get_tract
from tract.cli.formatting import get_console, format_error

@click.command()
@click.argument("target")
@click.option("--soft", "mode", flag_value="soft", default=True,
              help="Soft reset (default). Stores ORIG_HEAD for recovery.")
@click.option("--hard", "mode", flag_value="hard",
              help="Hard reset. Orphans forward commits.")
@click.option("--force", is_flag=True, help="Required for --hard reset.")
@click.pass_context
def reset(ctx, target, mode, force):
    """Reset HEAD to TARGET commit.

    Soft reset (default) stores ORIG_HEAD for recovery.
    Hard reset requires --force flag.
    """
    console = get_console()

    if mode == "hard" and not force:
        format_error("Hard reset requires --force flag. This orphans forward commits.", console)
        ctx.exit(1)
        return

    tract_obj = _get_tract(ctx)
    try:
        resolved = tract_obj.reset(target, mode=mode)
        console.print(f"HEAD reset to {resolved[:8]} ({mode})")
    except Exception as e:
        format_error(str(e), console)
        ctx.exit(1)
```

**5. Create `src/tract/cli/commands/checkout.py`:**

```python
"""tract checkout -- switch to a commit or branch."""
import click
from tract.cli import _get_tract
from tract.cli.formatting import get_console, format_error

@click.command()
@click.argument("target")
@click.pass_context
def checkout(ctx, target):
    """Checkout TARGET (commit hash, prefix, branch name, or '-').

    Checking out a branch attaches HEAD.
    Checking out a commit hash detaches HEAD (read-only, cannot commit).
    Use '-' to return to previous position.
    """
    tract_obj = _get_tract(ctx)
    console = get_console()

    try:
        resolved = tract_obj.checkout(target)
        # Determine if detached
        is_detached = tract_obj._ref_repo.is_detached(tract_obj._tract_id)
        if is_detached:
            console.print(f"HEAD detached at {resolved[:8]}")
            console.print("[dim]Cannot commit in detached state. Use 'tract checkout main' to return.[/dim]")
        else:
            branch = tract_obj._ref_repo.get_current_branch(tract_obj._tract_id)
            console.print(f"Switched to branch '{branch}' at {resolved[:8]}")
    except Exception as e:
        format_error(str(e), console)
        ctx.exit(1)
```

**6. Create `tests/test_cli.py`:**

Use Click's CliRunner for all tests. Each test creates a tract with SDK, then invokes CLI commands.

Test setup helper:
```python
import pytest
from click.testing import CliRunner
from tract import Tract, DialogueContent, InstructionContent, CommitOperation
from tract.cli import cli

@pytest.fixture
def runner():
    return CliRunner()

def _setup_tract(db_path: str) -> Tract:
    """Create a tract with a few commits for testing."""
    t = Tract.open(db_path)
    t.commit(InstructionContent(text="System prompt"), message="init")
    t.commit(DialogueContent(role="user", text="Hello"), message="user msg")
    t.commit(DialogueContent(role="assistant", text="Hi there"), message="reply")
    return t
```

Test categories (~20-25 tests):

**Log tests** (~5):
- `test_log_shows_commits`: Invoke `tract log --db test.db`, verify exit_code=0, output contains commit hashes and "append"
- `test_log_with_limit`: `tract log -n 1 --db test.db`, only 1 commit shown
- `test_log_verbose`: `tract log -v --db test.db`, output contains content type and token count columns
- `test_log_op_filter`: `tract log --op append --db test.db`, filters correctly
- `test_log_empty`: `tract log --db empty.db`, shows "No commits yet"

**Status tests** (~4):
- `test_status_shows_head`: Invoke `tract status --db test.db`, output contains HEAD hash, branch "main"
- `test_status_detached`: After checkout to commit hash, status shows "detached"
- `test_status_with_budget`: Configure budget, status shows progress bar
- `test_status_no_commits`: Status on empty tract shows "No commits yet"

**Diff tests** (~4):
- `test_diff_default`: `tract diff --db test.db`, shows diff between HEAD and parent
- `test_diff_two_commits`: `tract diff hash_a hash_b --db test.db`
- `test_diff_stat_flag`: `tract diff --stat --db test.db`, shows summary only
- `test_diff_no_commits`: `tract diff --db empty.db`, shows error

**Reset tests** (~4):
- `test_reset_soft`: `tract reset {hash} --db test.db`, succeeds
- `test_reset_hard_needs_force`: `tract reset {hash} --hard --db test.db`, fails with error about --force
- `test_reset_hard_with_force`: `tract reset {hash} --hard --force --db test.db`, succeeds
- `test_reset_invalid_hash`: Shows error message

**Checkout tests** (~4):
- `test_checkout_commit`: `tract checkout {hash} --db test.db`, shows "detached"
- `test_checkout_branch`: `tract checkout main --db test.db`, shows "Switched to branch"
- `test_checkout_dash`: After checkout, `tract checkout - --db test.db` returns to previous
- `test_checkout_invalid`: Shows error message

**Integration tests** (~3):
- `test_import_tract_no_cli_deps`: `import tract` succeeds without click/rich (test by verifying the import works -- in CI this would be tested in a clean env, here just verify no cli import in __init__.py)
- `test_cli_help`: `tract --help` shows group help
- `test_cli_subcommand_help`: `tract log --help` shows log help

All tests use `runner.isolated_filesystem()` with file-backed databases for persistence across CLI invocations. Setup pattern:
```python
def test_log_shows_commits(runner):
    with runner.isolated_filesystem():
        t = _setup_tract("test.db")
        t.close()
        result = runner.invoke(cli, ["--db", "test.db", "log"])
        assert result.exit_code == 0
        assert "append" in result.output.lower()
```
  </action>
  <verify>
1. `pip install -e ".[cli]"` then `python -m pytest tests/test_cli.py -v` -- all CLI tests pass
2. `python -m pytest tests/ -x -q` -- full suite passes (all existing + navigation + operations + CLI tests)
3. Manual smoke test: in a temp directory, run `tract --help`, `tract log --db test.db` (after creating a tract via SDK)
  </verify>
  <done>
All 5 CLI commands work: `tract log` (compact + verbose, with -n and --op), `tract status` (with progress bar), `tract diff` (with --stat and colored output), `tract reset` (--soft/--hard with --force guard), `tract checkout` (commit, branch, dash). CLI tests pass via CliRunner. Full test suite passes. pyproject.toml has [cli] optional extra. `import tract` does not require click/rich.
  </done>
</task>

</tasks>

<verification>
1. `tract log` shows commit history with hashes, timestamps, operations, token counts
2. `tract log -v` shows verbose output with content types and generation config
3. `tract log --op append` filters by operation type
4. `tract status` shows HEAD, branch, token count, recent commits
5. `tract diff` shows colored unified diff between commits
6. `tract diff --stat` shows summary line
7. `tract reset {hash}` resets HEAD (soft by default)
8. `tract reset {hash} --hard` requires --force
9. `tract checkout {hash}` detaches HEAD with warning
10. `tract checkout main` re-attaches HEAD
11. `tract checkout -` returns to previous position
12. `import tract` works without click/rich installed
13. All tests pass (full suite)
</verification>

<success_criteria>
- CLI package exists with 5 commands wrapping SDK operations
- Click group with --db option and lazy Tract opening
- Rich formatting for tables, diffs, progress bars
- CLI degrades when piped (Rich auto-detection)
- --force guard on hard reset
- pyproject.toml has [cli] extra and entry point
- All tests pass (existing + navigation + operations + CLI = ~320+ total)
</success_criteria>

<output>
After completion, create `.planning/phases/02-linear-history-cli/02-03-SUMMARY.md`
</output>
