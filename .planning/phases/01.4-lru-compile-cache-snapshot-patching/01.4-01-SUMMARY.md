---
phase: "01.4"
plan: "01"
subsystem: "compile-cache"
tags: [lru-cache, snapshot-patching, no-aggregation, oracle-testing]
dependency-graph:
  requires: ["01.1-01", "01.3-01"]
  provides: ["LRU compile cache", "EDIT snapshot patching", "annotate snapshot patching", "commit_hashes tracking", "verify_cache oracle", "no-aggregation compilation"]
  affects: ["02-01"]
tech-stack:
  added: []
  patterns: ["OrderedDict LRU cache", "dataclasses.replace for immutable patching", "oracle verification"]
file-tracking:
  key-files:
    created: []
    modified:
      - "src/tract/engine/compiler.py"
      - "src/tract/protocols.py"
      - "src/tract/models/compiled.py"
      - "src/tract/models/config.py"
      - "src/tract/tract.py"
      - "tests/test_engine/test_compiler.py"
      - "tests/test_tract.py"
decisions:
  - id: "01.4-01-no-aggregation"
    description: "Same-role consecutive messages preserved as separate messages; _aggregate_messages() removed entirely"
  - id: "01.4-01-parallel-hashes"
    description: "CompileSnapshot.messages and commit_hashes are always parallel (same length, same indexing)"
  - id: "01.4-01-lru-cache"
    description: "OrderedDict-based LRU cache (maxsize=8 default) replaces single CompileSnapshot"
  - id: "01.4-01-edit-patching"
    description: "EDIT commits patch cached snapshot in-memory (find by commit_hash, replace message, recount tokens)"
  - id: "01.4-01-annotate-patching"
    description: "Annotate SKIP patches snapshot by removing target; un-skip falls back to full recompile"
  - id: "01.4-01-annotate-clear"
    description: "Annotation clears entire cache then re-adds patched current HEAD (other entries may be stale)"
  - id: "01.4-01-oracle"
    description: "verify_cache=True on Tract.open() cross-checks cache hit/patch against full recompile"
metrics:
  duration: "4m"
  completed: "2026-02-11"
---

# Phase 1.4 Plan 01: LRU Compile Cache and Snapshot Patching Summary

**One-liner:** OrderedDict LRU cache with EDIT/annotate in-memory patching, no-aggregation compilation, and oracle verification via verify_cache flag.

## What Changed

### Task 1: Remove same-role aggregation and simplify data model (a161e9e)

- Deleted `_aggregate_messages()` from `DefaultContextCompiler` entirely
- Removed `aggregate_same_role` field from `CompileOptions`
- Simplified `CompileSnapshot`: replaced `raw_messages`/`aggregated_messages`/`effective_hashes` with `messages` and `commit_hashes` (parallel tuples)
- Added `commit_hashes: list[str]` to `CompiledContext`, populated by the compiler from effective commits
- Simplified `_extend_snapshot_for_append()` -- no tail aggregation logic
- Updated all aggregation tests to assert separate messages (4 tests replaced in test_compiler.py, 2 in test_tract.py)

### Task 2: LRU cache infrastructure (45f347d)

- Added `compile_cache_maxsize: int = 8` to `TractConfig`
- Replaced `self._compile_snapshot: CompileSnapshot | None` with `self._snapshot_cache: OrderedDict[str, CompileSnapshot]`
- Added `verify_cache: bool = False` parameter to `Tract.open()` and `Tract.from_components()`
- Added three private LRU helpers: `_cache_get()`, `_cache_put()`, `_cache_clear()`
- Updated `compile()` to use LRU with oracle verification on cache hit
- Updated `commit()` APPEND to look up parent snapshot from LRU
- Updated `record_usage()` to use `dataclasses.replace()` with LRU
- Updated `batch()` and `annotate()` to use `_cache_clear()`
- Updated existing tests referencing `_compile_snapshot` to use new API

### Task 3: EDIT/annotate snapshot patching + oracle tests (cc2d2d4)

- Implemented `_patch_snapshot_for_edit()`: finds message by `commit_hashes.index(target_hash)`, replaces in-memory, recounts tokens. Handles edit-inherits-original and copy-on-input for generation_config.
- Implemented `_patch_snapshot_for_annotate()`: SKIP removes target message; NORMAL/PINNED on included commit returns as-is; on excluded commit returns None (full recompile).
- Wired EDIT patching into `commit()` -- does NOT clear cache (other HEAD entries stay valid).
- Wired annotate patching into `annotate()` -- clears all entries then re-adds patched current HEAD.
- Added 16 new tests in `TestLRUCompileCacheAndPatching` class covering: LRU hits, multiple heads, eviction, EDIT patching (oracle), generation_config preservation, annotate SKIP/un-skip, stale cache clearing, batch, record_usage, commit_hashes, and consecutive same-role with EDIT.

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Remove aggregation entirely | Aggregation destroyed event boundaries and made commit-to-message mapping impossible. Without it, messages and commit_hashes are trivially parallel. |
| OrderedDict LRU (not functools.lru_cache) | Need manual eviction control, key-based lookup, and clear() for batch/annotate. OrderedDict provides all three with O(1) operations. |
| EDIT does not clear cache | Other HEAD entries at different positions are still valid -- the EDIT commit is a new commit not in their chains. Only the parent's entry needs patching. |
| Annotate clears all + re-adds patched | Annotations affect ALL snapshots containing the target. Safe approach: clear everything, re-add only the (patchable) current HEAD. |
| verify_cache defaults to False | Oracle check doubles every compile(). Only for testing/debugging, not production. |
| maxsize=8 default | Covers typical branching patterns (main + feature + a few checkouts). Configurable via TractConfig. |

## Deviations from Plan

None -- plan executed exactly as written.

## Test Results

- **Total tests:** 267 (250 existing + 1 new from no-aggregation + 16 from LRU/patching)
- **Execution time:** 3.06s
- **Oracle tests:** All `verify_cache=True` tests pass (patched results identical to full recompile)

## Verification Checklist

- [x] `_aggregate_messages()` removed from DefaultContextCompiler
- [x] `aggregate_same_role` removed from CompileOptions
- [x] `_compile_snapshot` fully replaced by `_snapshot_cache` (0 matches in tract.py)
- [x] `commit_hashes` on both CompileSnapshot and CompiledContext
- [x] `_snapshot_cache` (OrderedDict LRU) present in tract.py
- [x] `verify_cache` oracle flag wired through open/from_components/compile
- [x] All 267 tests pass with zero regressions

## Next Phase Readiness

No blockers. Phase 1.4 is complete (1/1 plans). The codebase is ready for Phase 2 (Linear History & CLI).
